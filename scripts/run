#!/usr/bin/env bash
set -euo pipefail

# Monster Forge - Run Script
# Supports both TUI (interactive) and CLI (for agents) modes

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Check if gum is available for TUI
has_gum() {
  command -v gum &>/dev/null
}

# Check if running interactively
is_interactive() {
  [[ -t 0 && -t 1 ]]
}

# Logging functions
log_info() { echo -e "${BLUE}â„¹${NC} $1"; }
log_success() { echo -e "${GREEN}âœ“${NC} $1"; }
log_error() { echo -e "${RED}âœ—${NC} $1" >&2; }
log_warn() { echo -e "${YELLOW}âš ${NC} $1"; }

# Header
show_header() {
  if has_gum && is_interactive; then
    gum style \
      --border normal \
      --border-foreground 212 \
      --padding "0 1" \
      --margin "1 0" \
      "ðŸ”¥ Monster Forge v2.0"
  else
    echo -e "\n${BOLD}${CYAN}ðŸ”¥ Monster Forge v2.0${NC}\n"
  fi
}

# Check prerequisites
check_prerequisites() {
  local missing=()
  
  if ! command -v bun &>/dev/null; then
    missing+=("bun")
  fi
  
  if ! command -v op &>/dev/null; then
    missing+=("op (1Password CLI)")
  fi
  
  if [ ${#missing[@]} -gt 0 ]; then
    log_error "Missing required tools: ${missing[*]}"
    echo "Install with:"
    echo "  brew install oven-sh/bun/bun"
    echo "  brew install 1password-cli"
    exit 1
  fi
}

# Setup environment from 1Password
cmd_setup() {
  log_info "Setting up environment from 1Password..."
  
  if [ ! -f ".env" ]; then
    ./scripts/setup-env.sh
  else
    log_warn ".env already exists"
    if has_gum && is_interactive; then
      if gum confirm "Regenerate .env from 1Password?"; then
        ./scripts/setup-env.sh
      fi
    else
      log_info "Use 'run setup --force' to regenerate"
    fi
  fi
  
  log_info "Installing dependencies with Bun..."
  bun install
  
  log_success "Setup complete!"
}

# Start development server
cmd_dev() {
  log_info "Starting development server..."
  
  if [ ! -f ".env" ]; then
    log_warn "No .env file found. Running setup first..."
    cmd_setup
  fi
  
  bun run dev
}

# Build for production
cmd_build() {
  log_info "Building for production..."
  bun run build
  log_success "Build complete! Output in ./build"
}

# Preview production build
cmd_preview() {
  log_info "Previewing production build..."
  
  if [ ! -d "build" ]; then
    log_warn "No build found. Building first..."
    cmd_build
  fi
  
  if ! command -v serve &>/dev/null; then
    log_info "Installing serve..."
    bun add -g serve
  fi
  
  serve -s build
}

# Run tests
cmd_test() {
  log_info "Running tests..."
  bun run test
}

# Clean project
cmd_clean() {
  log_info "Cleaning project..."
  rm -rf node_modules build .env bun.lockb
  log_success "Cleaned: node_modules, build, .env, bun.lockb"
}

# Check environment status
cmd_status() {
  echo -e "\n${BOLD}Environment Status${NC}"
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  
  # Check .env
  if [ -f ".env" ]; then
    log_success ".env file exists"
    
    # Check API keys (masked)
    if grep -q "REACT_APP_ANTHROPIC_API_KEY=sk-" .env 2>/dev/null; then
      log_success "Anthropic API key configured"
    else
      log_warn "Anthropic API key missing or invalid"
    fi
    
    if grep -q "REACT_APP_GOOGLE_API_KEY=AIza" .env 2>/dev/null; then
      log_success "Google API key configured"
    else
      log_warn "Google API key missing or invalid"
    fi
  else
    log_warn ".env file not found (run 'setup')"
  fi
  
  # Check dependencies
  if [ -d "node_modules" ]; then
    log_success "Dependencies installed"
  else
    log_warn "Dependencies not installed (run 'setup')"
  fi
  
  # Check build
  if [ -d "build" ]; then
    log_success "Production build exists"
  else
    log_info "No production build (run 'build')"
  fi
  
  echo ""
}

# Show help
cmd_help() {
  echo -e "${BOLD}Monster Forge CLI${NC}"
  echo ""
  echo -e "${BOLD}Usage:${NC} ./run [command] [options]"
  echo ""
  echo -e "${BOLD}Commands:${NC}"
  echo "  setup     Setup environment (1Password + dependencies)"
  echo "  dev       Start development server"
  echo "  build     Build for production"
  echo "  preview   Preview production build"
  echo "  test      Run tests"
  echo "  status    Check environment status"
  echo "  clean     Remove build artifacts and dependencies"
  echo "  help      Show this help message"
  echo ""
  echo -e "${BOLD}Examples:${NC}"
  echo "  ./run              # Interactive TUI menu"
  echo "  ./run dev          # Start dev server directly"
  echo "  ./run setup        # Setup environment"
  echo ""
  echo -e "${BOLD}Environment:${NC}"
  echo "  API keys are stored in 1Password vault 'monster-forge'"
  echo "  Run './run setup' to pull keys and install dependencies"
}

# Interactive TUI menu
show_menu() {
  if ! has_gum; then
    log_error "gum is required for interactive mode"
    echo "Install with: brew install gum"
    echo "Or use CLI: ./run help"
    exit 1
  fi
  
  show_header
  
  local choice
  choice=$(gum choose \
    "dev       â†’ Start development server" \
    "setup     â†’ Setup environment (1Password + deps)" \
    "build     â†’ Build for production" \
    "preview   â†’ Preview production build" \
    "test      â†’ Run tests" \
    "status    â†’ Check environment status" \
    "clean     â†’ Clean project" \
    "help      â†’ Show help" \
    "exit      â†’ Exit" \
  )
  
  # Extract command from choice
  local cmd
  cmd=$(echo "$choice" | awk '{print $1}')
  
  case "$cmd" in
    dev)     cmd_dev ;;
    setup)   cmd_setup ;;
    build)   cmd_build ;;
    preview) cmd_preview ;;
    test)    cmd_test ;;
    status)  cmd_status ;;
    clean)   cmd_clean ;;
    help)    cmd_help ;;
    exit)    exit 0 ;;
  esac
}

# Main entrypoint
main() {
  local command="${1:-}"
  shift || true
  
  # If no command and interactive, show TUI menu
  if [ -z "$command" ]; then
    if is_interactive && has_gum; then
      show_menu
    else
      cmd_help
    fi
    exit 0
  fi
  
  # Handle CLI commands
  case "$command" in
    setup)
      check_prerequisites
      cmd_setup "$@"
      ;;
    dev|start)
      check_prerequisites
      cmd_dev "$@"
      ;;
    build)
      check_prerequisites
      cmd_build "$@"
      ;;
    preview)
      check_prerequisites
      cmd_preview "$@"
      ;;
    test)
      check_prerequisites
      cmd_test "$@"
      ;;
    status)
      cmd_status "$@"
      ;;
    clean)
      cmd_clean "$@"
      ;;
    help|--help|-h)
      cmd_help
      ;;
    *)
      log_error "Unknown command: $command"
      cmd_help
      exit 1
      ;;
  esac
}

main "$@"
